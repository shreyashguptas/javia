# Device Authentication

## Overview

The voice assistant system uses **UUID-based authentication** for Pi clients, providing secure, per-device identification and authorization.

## How It Works

### 1. Device UUID Generation

Each Raspberry Pi client automatically generates a unique UUID7 on first boot:

- **UUID Location**: `~/.javia_device_uuid`
- **Generated By**: `device_manager.py` on first run
- **Format**: UUID7 (time-sortable, e.g., `01234567-89ab-cdef-0123-456789abcdef`)
- **Persistence**: Stored in user's home directory, survives updates

### 2. Device Registration

Devices **must be manually registered** on the server before they can make requests:

```bash
# On the server (after Pi client setup)
cd /opt/javia/scripts/register_device
sudo ./register_device.sh <DEVICE_UUID> "Device Name" "America/Los_Angeles"
```

This:
- Validates the UUID format
- Adds the device to the Supabase `devices` table
- Sets initial status to `online`
- Allows the device to authenticate requests

### 3. Request Authentication

All Pi client requests to `/api/v1/process` include:

```
X-Device-UUID: <device_uuid>
```

The server middleware (`device_auth.py`):
1. Extracts the UUID from the header
2. Queries Supabase for the device
3. Checks if the device is registered and active
4. Returns `403 Forbidden` if not registered or inactive

## Key Files

### Pi Client

- **`device_manager.py`**: Manages UUID generation and persistence
- **`client.py`**: Sends `X-Device-UUID` header with all requests
- **`~/.javia_device_uuid`**: Stores the device's unique UUID

### Server

- **`middleware/device_auth.py`**: Validates device UUID for client requests
- **`middleware/auth.py`**: Validates admin API key for management endpoints
- **`scripts/register_device/register_device.sh`**: Registers new devices
- **Supabase `devices` table**: Stores registered devices

## Admin vs Device Authentication

The system uses two separate authentication mechanisms:

### Device Authentication (Pi Clients)
- **Header**: `X-Device-UUID`
- **Endpoints**: `/api/v1/process` (main voice processing)
- **Purpose**: Per-device identification and authorization
- **Managed By**: Server-side registration script

### Admin Authentication (Management)
- **Header**: `X-API-Key`
- **Endpoints**: `/api/v1/devices/*`, `/api/v1/updates/*`
- **Purpose**: Administrative operations (device management, OTA updates)
- **Managed By**: Server environment variable (`SERVER_API_KEY`)

## Security Benefits

1. **Per-Device Control**: Each device has a unique identifier
2. **Easy Revocation**: Disable a device by updating its status in the database
3. **No Shared Secrets**: No API key shared across all devices
4. **Audit Trail**: Track which device made which request
5. **Scalability**: Add/remove devices without changing server configuration

## Troubleshooting

### Device UUID Not Generated

If the UUID file doesn't exist after setup:

```bash
# Check service logs for initialization errors
sudo journalctl -u voice-assistant-client.service -n 100

# Look for "[INIT] ✓ Device UUID:" message
# The UUID will be printed in the logs
```

### 403 Forbidden Error

If the device receives a 403 error:

```
[ERROR] Forbidden - Device not registered or not authorized
[ERROR] Device UUID: 01234567-89ab-cdef-0123-456789abcdef
```

**Solution**: Register the device on the server:

```bash
cd /opt/javia/scripts/register_device
sudo ./register_device.sh 01234567-89ab-cdef-0123-456789abcdef "Device Name" "UTC"
```

### Device Shows as Offline

If a registered device shows as `offline` in the database:

1. The device may have been manually set to offline
2. Update the device status via the admin API or directly in Supabase
3. Or re-register the device using the registration script

## Migration from API Key Authentication

**Old System** (deprecated):
- All devices shared a single `CLIENT_API_KEY`
- Sent via `X-API-Key` header
- No per-device identification

**New System** (current):
- Each device has a unique UUID
- Sent via `X-Device-UUID` header
- Full per-device management

**Migration Steps**:
1. Run updated `setup.sh` on Pi clients
2. Note the generated UUID
3. Register each device on the server
4. Old `CLIENT_API_KEY` environment variable is ignored

## API Examples

### Client Request (Pi → Server)

```python
import requests

headers = {
    'X-Device-UUID': '01234567-89ab-cdef-0123-456789abcdef'
}

response = requests.post(
    'https://yourdomain.com/api/v1/process',
    files={'audio': open('recording.opus', 'rb')},
    headers=headers
)
```

### Admin Request (Management)

```bash
# Register device
curl -X POST https://yourdomain.com/api/v1/devices/register \
  -H "X-API-Key: your_admin_key" \
  -H "Content-Type: application/json" \
  -d '{
    "device_uuid": "01234567-89ab-cdef-0123-456789abcdef",
    "device_name": "Living Room Pi",
    "timezone": "America/Los_Angeles"
  }'
```

## Related Documentation

- [Getting Started Guide](GETTING_STARTED.md)
- [API Reference](API.md)
- [OTA Updates](OTA_UPDATES.md)
- [Server Deployment](../server/scripts/setup/setup.md)

